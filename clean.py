import pandas as pd
from pathlib import Path
import numpy as np

#splitting the data before, calculating any mean values is important


def store_clean():
    # this could have been done with scikit learn inputter?
    store = pd.read_csv("./data/store.csv")
    store['Promo2SinceWeek'] = store.Promo2SinceWeek.fillna(0)
    store['Promo2SinceYear'] = store.Promo2SinceYear.fillna(0)
    store['PromoInterval'] = store.PromoInterval.fillna('None')
    store['CompetitionDistance'] = store.CompetitionDistance.fillna(round(store.CompetitionDistance.mean()))
    store['CompetitionOpenSinceMonth'] = store.CompetitionOpenSinceMonth.fillna(round(store.CompetitionOpenSinceMonth.mean()))
    store['CompetitionOpenSinceYear'] = store.CompetitionOpenSinceYear.fillna(round(store.CompetitionOpenSinceYear.mean()))
    return store


# Lambda functions for data cleaning

def customers_nan(sales, customers):
        mean_sales_customers = 9.38648627379399 # (train['Sales'] / train['Customers']).mean()
        if customers != customers:  # Clever way of verifying if an object  is null
            return round(sales / mean_sales_customers)
        else: 
            return customers
        
        
def sales2(customer, store):
    
    return sales_div_customers[int(store)-1] * customer


# Cleaning training dataset

def train_clean(path, test=False):
    
    # Setting index and time auxiliary columns
    train = pd.read_csv(path, parse_dates=True, index_col='Date')
#     train.index = pd.to_datetime(train.index)
    train['year'] = train.index.year
    train['month'] = train.index.month
    train['week'] = train.index.week
    train['day'] = train.index.day
    train['day_week'] = train.index.dayofweek
    train['month_start'] = train.index.is_month_start
    train['month_end'] = train.index.is_month_end
    holidays = train['StateHoliday'].replace({0 : 0, None : 0}).astype(str)
    train['StateHoliday_new'] = holidays
    
    # Dropping all the rows with sales == 0 or sales == nan
    if test == False:
        train = train[(train.Sales != 0) & (train.Sales.isna() != True)]
    
    # Drop missing Store
    
    train = train[(train.Store.isna() != True)]
    
    # Drop DayOfWeek as this information is in day_week
    
    train.drop(axis=1, labels='DayOfWeek', inplace=True)
    
    #Substitute missing values in customers by the mean of Sales and Customers
    
    if test == False:
        print(test)
        train['Customers'] = train.apply(lambda x: customers_nan(x['Sales'], x['Customers']), axis=1)
    
    # Set Open Column to 1 OR DROP IT
    
    train['Open'] = train.loc[:, 'Open'].apply(lambda x: 1)
    
    # Fill train['Promo'] with 0
    
    train['Promo'] = train.Promo.fillna(0)
    
    # Check if you can improve the missing values on State Holiday and School Holiday
    
    train.drop(axis=1, labels= ['StateHoliday'], inplace=True)
    
    train['SchoolHoliday'] = train['SchoolHoliday'].fillna(0)
    
    # ADDING NEW COLUMNS
    
    train['sales_customers'] = train.apply(lambda x: sales2(x['Customers'], x['Store']), axis=1)
    
    return train


def transformations():
    train = train_clean()


def test_clean(test):
    # First step in the test set is to get rid of the values Sales = 0 | Sales = nan
    test = test[(test.Sales != 0) & (test.Sales.isna() != True)]

    
# sales_div_customers = (train.groupby(['Store']).mean().Sales/train.groupby(['Store']).mean().Customers).to_numpy()    
sales_div_customers = np.array(
       [8.37777761,  8.37246974,  9.18079399,  7.23003125,  8.62845162,
        8.62423586,  9.11728319,  8.28845847, 11.01728091,  9.21664363,
        7.06374535,  8.36026946, 12.61960123,  8.66530175,  9.8598892 ,
        8.85938848,  7.89540969,  8.94919411, 10.10768489,  8.96213687,
       10.26865154,  8.84996615, 11.30993811, 10.96689569,  7.11801248,
       11.71030075,  8.66020839,  9.02542644, 10.96545388,  6.80391067,
        9.81213799,  8.47020011,  9.9928293 ,  8.03536259, 12.81250292,
        8.44108402,  9.06270715, 11.12833444,  7.5847922 ,  7.40376763,
       13.03758277,  9.10487176, 11.16775845,  8.53864903, 12.66899235,
        8.04216204,  7.58462037,  8.97032445, 13.32014251, 11.74282612,
       13.05435542, 14.25476949,  9.15512592, 10.58546658,  8.08619962,
       14.14859266, 10.78622595, 11.91766304,  9.58410109, 10.94224186,
        8.05540937,  8.96919319, 10.60088424, 12.44887645, 10.86264905,
       11.42139594,  9.67964583,  6.4787836 ,  8.05823445,  9.55397464,
       11.85900962,  9.20175332,  9.07393952,  7.30693678,  9.21250231,
        9.55571776, 11.15977886,  7.37603789,  9.6362889 , 12.94748622,
       12.10034586, 10.62333235, 10.99236953,  9.15069399,  7.14914281,
        7.66293341,  7.9748868 ,  9.70824655,  9.44028778,  7.87624498,
        8.80398599, 10.60914707,  9.71563773, 10.89207271,  9.09299234,
        9.35180363,  9.51578528, 11.03790792, 10.77363796, 11.39174987,
        9.34521423,  6.57395186, 11.02543112,  7.66535045,  8.51264181,
       10.41991583,  7.63476782, 12.53167218,  8.6115744 ,  7.65609966,
       11.12388734,  7.96688138, 10.38182825,  8.64307211, 12.93336756,
        9.51811193,  7.86845128, 11.24238971,  8.89710761, 11.02391394,
        8.64433511,  8.00817183,  8.63354704,  8.38149994,  7.51390137,
       12.5708623 ,  7.9265406 , 12.18859338,  7.9145652 ,  8.79267451,
        9.34151394, 10.49531192,  8.3249614 ,  9.59747152, 10.80152447,
       12.75507908,  8.58050051,  9.99937581, 12.32596443,  7.7103156 ,
        9.02844564,  8.0565087 , 10.57794353, 10.54955499,  6.48470648,
       10.86548992,  9.22923273, 10.3728586 , 11.33426859, 10.04253188,
       10.18568514,  8.81185416, 11.02500766, 11.60998724, 10.35902778,
        9.61083376,  9.6685196 , 15.13455599, 10.99972165, 10.12901969,
        8.72182646, 13.61898303,  8.45135405,  9.65597774,  9.41505788,
        7.22969359,  8.62726302, 10.16888933, 10.38436615,  9.22282063,
        9.64387287,  7.97248339,  8.15530246, 12.20099777,  8.26641342,
        8.30524996,  8.14971242, 10.68043349,  7.58815176,  8.47406666,
        9.47005132, 12.33125302,  7.82916023, 10.90218951, 12.73560624,
        9.67308203,  7.99211152, 11.07524657, 10.41245022, 10.80058324,
        9.53116701, 13.33292907,  6.81568347, 11.28270873,  8.16459665,
        7.38843511,  8.06751049,  8.58610217, 12.37681311,  7.91761635,
       11.51041589, 11.69804197,  7.62691656, 10.26555775,  7.45152011,
        8.74404752,  8.55647197,  7.03931597,  9.47055036,  9.53000729,
        8.64541519, 10.1775413 , 12.11934593, 12.60208509, 12.58890319,
        8.10317902,  7.23174062,  7.18491225,  7.65552505,  7.55780028,
       10.28695897,  8.80978343,  9.70139197, 13.40999937,  9.15892006,
       10.28542991, 10.33825743, 12.97479223, 11.51027674,  7.93057842,
       11.81006387, 10.79713478,  9.06290701, 10.6725298 , 11.62413024,
        8.15126423,  7.87232031,  7.00754636, 10.53574244, 10.36740384,
        9.15423047, 10.95443806,  7.40110344,  9.4384436 ,  8.78954603,
        7.48096841, 12.22673291,  7.41105827,  9.6256701 , 12.52104561,
        7.77895378, 12.72364286,  8.32831423, 11.22649993,  9.64834239,
        7.81204334,  8.3772401 , 11.19996395,  4.8861342 ,  7.25178549,
       12.9471439 ,  6.08578787, 10.09704736,  7.65865548,  9.69623442,
        8.26219261,  8.26242233,  8.07221295,  7.58504396,  7.71786047,
        9.6390157 ,  9.75069994,  9.77640733,  4.04816446,  9.8844939 ,
        7.88337715, 11.86311848,  8.89815972, 12.92609574, 11.77312424,
       10.43941976,  6.78322311,  9.65049734, 11.71057576, 10.76617768,
       11.35396152,  9.81613189, 13.13987151, 11.33142121, 10.13077665,
        9.43642807,  8.10287173,  7.61524005,  7.50216007,  7.79762747,
        9.04795219,  9.59246673, 11.96472605,  9.02942078,  8.00391486,
        9.0998784 , 11.38607826,  9.14371235,  6.6333477 , 10.18042819,
        9.24962562,  8.66776229,  9.98191035, 11.56952397, 11.40518982,
        8.323524  , 10.20616794,  9.81838181,  8.8441692 ,  9.28764217,
       10.7898185 ,  9.18074029, 11.25976266,  9.04790264,  7.12767956,
        9.96532651,  9.04866328, 11.60883675,  7.80147229,  9.54122762,
       11.6591903 ,  8.10675021,  8.37912638, 10.93081529,  9.19214495,
        7.49614842,  7.3846412 ,  7.68324522,  9.54421964,  5.48731478,
        7.07901746, 12.76295949, 11.33237117,  7.39901599,  8.91065125,
        7.30825368, 12.74720254,  9.92566872,  7.3446952 ,  9.18261333,
       10.73883772, 12.22042762, 11.74606338,  9.66585552, 12.8600176 ,
       11.33351248, 10.34476205,  3.82070633, 11.65523643,  8.23011293,
       12.66258164,  7.49256193,  9.060404  , 11.05981337,  9.06341978,
        9.6732659 ,  8.19939628,  7.56748636,  7.83474723,  9.14247459,
       10.0970722 ,  9.62761838, 13.21104311, 11.81910875, 11.78955471,
       12.39390884, 11.18274596, 13.75006454,  8.41634844, 11.81912193,
        8.7852142 ,  7.89738964,  6.44442159,  8.23633384, 10.28318607,
        9.18368637, 12.05232418,  7.79748663,  8.69066219, 11.0056252 ,
       12.44351579,  7.6927656 ,  9.18729807,  7.99573339, 10.63986683,
        8.20204748,  9.94930101,  9.9917927 , 12.35023939,  7.62569322,
        9.30495855,  7.21760317,  8.79837305,  9.63794836,  7.21676918,
       10.53944453,  9.37074524, 10.03659889,  8.24830856,  9.1824844 ,
       12.42421807, 12.09606895,  9.94554429, 10.00943292,  7.91811594,
       12.67291989, 13.90492491,  7.88975869, 12.90023242, 11.73610059,
        7.81408576,  9.41268918,  9.42643366,  6.21741283, 11.16738263,
        9.28617894,  9.66044787,  5.73990497,  8.80639462,  7.39917288,
        7.95017323,  9.91212121, 11.78926117, 12.1740401 , 12.14998351,
        9.32163253,  7.01463529,  8.65406146, 13.0102448 ,  8.50211835,
        8.84494112,  9.99012607,  9.64961163,  8.15445627,  8.56963748,
        8.95949469,  9.35067577, 10.49082134,  8.51649088,  6.28457929,
        7.58546104,  8.46192627, 11.21483169,  7.30357688,  7.93929235,
       11.50546065, 10.65495023,  8.42797142,  8.06589972, 15.04273177,
        6.9946781 , 10.98865437, 10.70289462,  8.02203659, 10.64954501,
       10.06442835,  7.92279757,  6.26855964,  8.0777679 , 12.47845026,
       10.01337697,  8.28683544,  8.74087843,  7.81995058,  7.32226323,
       11.88041001,  7.40443996,  7.26807301,  9.99135464,  6.60889744,
        8.87634729, 13.506099  ,  9.5929629 ,  8.31533962,  7.86856719,
       10.47094714,  8.9196293 ,  7.49732601, 10.23934667, 11.38245034,
        8.07009696, 10.11799551,  9.38243334, 10.96360373,  7.68352189,
       12.36844218,  6.76606498, 10.03269072,  7.06967497, 12.76603481,
        9.04811794,  8.03444476,  7.88152221,  6.88322603, 13.11263318,
        9.105176  ,  7.07335705, 13.76586858,  6.96498548,  7.92758389,
        8.9641704 , 12.4513848 ,  9.9868088 , 11.59978596,  9.50625917,
        6.98090473,  4.24148733,  8.61747756,  9.38286703, 12.0186588 ,
        7.62979029,  9.08296458, 11.33720388,  9.25555882,  9.19440019,
       11.87785067, 12.65543975,  8.70089451,  9.25991994, 11.61828932,
        7.19729519, 10.56251241, 10.91969433, 10.04409554,  6.16393101,
        8.04867093,  8.47677217, 10.40655089, 12.82163496,  8.69789984,
        9.23869489,  9.08487799,  6.79003087,  9.79087794, 13.8117147 ,
        7.71616224, 11.54282234, 11.51566108,  7.54040236, 10.10087967,
        8.37531951, 12.70097836, 12.26110437,  8.40416158, 11.69176878,
        6.58996193, 11.08381477, 10.81896076,  8.12141913, 10.67275153,
        8.5740075 ,  6.46978145,  7.11570614,  7.71170752,  8.23525625,
       10.03111051,  5.81742615,  7.7557815 , 11.13794177,  8.25755348,
        8.67257227,  7.76575934, 11.53055893,  6.97079722,  6.97818154,
       13.0920249 , 11.81455128, 11.7153097 , 12.94949737, 10.69581941,
        7.16069607,  8.20360942, 10.37213878,  9.0469322 ,  6.37027194,
        9.05595873,  8.09961454,  9.47488879, 10.69663846,  6.6295995 ,
        6.42387851, 13.52739476,  9.13252445,  9.16292575, 12.35240816,
       11.21110392,  7.71345879,  7.66701654,  9.03582388,  8.40935642,
        6.45807978,  6.93459556,  8.06653518, 10.97466424, 11.03090783,
       12.01008531, 10.03720157,  7.2664598 , 13.23788559, 13.40109559,
        9.32485897,  9.43152829,  9.63162269,  9.07391655,  8.05028506,
       11.52248521, 15.38687657,  6.71695609,  6.95921237,  7.82650968,
       10.10033778, 10.77542062, 13.18733061,  9.89785545, 10.70179472,
        7.25890257,  9.84711238,  8.6152323 , 10.12731121, 10.09066014,
       11.14646361,  9.54658186,  8.09960433, 11.222756  ,  8.68368771,
        8.31398592,  7.70432999, 12.76649595, 10.04003292,  9.72340853,
        8.2205739 , 12.29724007, 11.66815892,  9.69112129, 12.72137731,
       10.38576656,  7.61765482,  7.81754688,  8.89535561,  7.99131209,
        7.07703421,  8.43186353, 10.49147833,  9.30520241,  9.47368624,
        7.94364033,  9.5309963 , 11.63587517,  9.20385546, 11.40826276,
        8.52822007,  7.70093491, 10.07488153,  8.21938451,  9.11439401,
       11.97538787, 10.80389291,  7.15553154,  8.07494809,  6.50038964,
       10.73318011, 10.9514193 ,  7.63902624, 11.23530341,  9.35314281,
        9.70271443,  6.24845711, 11.78526115,  7.93540152,  9.51421712,
        4.44867909, 12.32865886,  8.77641381,  9.29116547,  6.53004525,
        7.17555182,  6.36827611, 10.54367013, 12.08893863, 10.87930878,
        8.23503118, 11.1185069 ,  9.76067962,  9.89920187,  7.07699046,
       13.17748569,  8.23483721, 13.03768329, 10.16547859, 10.18292218,
        7.62295737, 10.37679114,  8.01042766,  8.37096893,  8.14492584,
        9.07946185, 12.49377186,  9.27874778,  9.50866112,  8.17260491,
       10.73089362,  8.94595439,  8.88739229,  7.64503474, 11.88362514,
       13.31872424, 11.19849761,  8.16213013, 13.31259677,  9.56531772,
       12.32733908,  9.73261535,  9.13171414, 11.7256216 ,  9.76508348,
        9.89095356,  6.24452862, 12.0304084 ,  9.54678126,  9.48718724,
       10.14639761,  9.88094622, 11.15618231,  9.56306142,  8.15176776,
        9.58569973,  8.70456308,  4.37850962, 10.36156893,  9.95160491,
       10.12020104,  6.69070386, 11.85091799, 12.2839406 , 13.43499778,
        8.22689915,  9.04315671,  8.95877025,  8.81249452, 10.34992332,
       11.46452364, 11.15501403, 11.55296241,  8.17115415, 12.22102719,
        7.3965628 , 11.16872048, 11.26540951,  8.23321223, 11.38730638,
        7.04946931, 11.30360308,  7.55497903,  8.81201189,  6.21429113,
        8.70547631,  9.70192542, 10.20042052,  8.69487489, 11.6773326 ,
       11.33739978,  9.64712585,  9.56054739,  3.4990729 ,  8.68218203,
        9.66656424,  7.23998048,  7.25638987,  7.63450714, 13.63724982,
        8.91710771, 10.99657139,  7.32759759,  9.99796608,  8.19812442,
        7.33223936, 10.49512957,  9.87020479,  9.36693508, 11.24016793,
        6.37944448,  8.78529732, 10.30868544,  6.9980068 , 10.69445291,
        9.26695951, 10.49932986, 10.41940715,  5.82036187,  9.61967196,
       10.58529986,  9.84104046,  8.18484622, 10.86455885, 10.65117495,
       10.0531877 , 12.62085123, 11.9424908 , 10.9554729 , 10.51358623,
       12.61067174,  9.90083448, 11.86300687, 11.44442793, 11.94054457,
        6.09982681,  8.08801266,  8.82179917, 11.98302142, 10.23417658,
        6.89528794,  6.90752812,  9.4420391 , 11.09642563, 10.8877391 ,
        8.06470503, 11.87044945,  9.94379916,  7.92087876,  8.41280328,
       11.14231672,  7.59514759,  8.71602042,  7.49592472, 11.37674078,
        8.0322057 , 11.64452365, 10.70200172,  9.1125834 ,  7.52017107,
        8.17026063,  7.26591562,  9.48552351,  7.97300771,  7.00559006,
        7.29202785, 15.49205486,  8.4207201 ,  8.95519498, 13.09675042,
       10.4367592 ,  6.99936152,  8.60262002,  9.0072667 ,  9.20074164,
       11.40430819,  7.85825866,  9.00891675,  9.57366775,  9.28382815,
        7.47899934,  7.82364669, 11.17404689, 10.22526585,  7.77723053,
        6.74949463,  7.53238605,  8.27109064,  7.25589186, 11.54109376,
       13.83401396, 10.30007671, 14.15726896,  6.81528869,  7.90615093,
       12.65039851, 10.3694975 ,  8.3435908 ,  8.91227448, 10.63036566,
        8.87613403,  7.22229409, 10.84857191, 10.65216819,  9.40223212,
        6.70948534,  7.79632443,  9.41199666, 10.32157982,  7.34789724,
       10.42190379, 11.72536033, 10.45985344,  9.00126229, 12.49830107,
        7.21394967,  9.62793183,  7.62786562,  8.19120419, 10.26384516,
        6.38450952, 10.45625013,  9.2547176 ,  9.20310269, 10.40430293,
       11.17060587,  7.81916121, 13.9044542 , 11.4682611 ,  6.8337134 ,
        8.64911984,  7.41974561, 11.59348802, 10.2698337 ,  9.67990212,
       10.6435437 ,  7.56056147,  7.70387612,  8.23629295, 11.9422816 ,
        7.5872827 ,  8.9802228 ,  9.19307652,  8.15261678,  9.67531255,
        8.61307602, 10.24186994,  8.29151083, 10.41598887,  5.6131643 ,
       13.14785598,  7.50225155, 11.32396344,  8.07384717,  6.16939755,
        8.0358303 ,  9.99036228,  7.94825717,  9.78493065,  9.21389658,
        7.91544484, 12.00872455,  9.68780452, 10.28141013,  9.6191877 ,
        8.87975631, 12.56404723, 11.25932524,  6.47841051,  8.16795244,
        7.89159693,  7.386611  ,  3.97001557, 10.62461156, 10.17715814,
       10.6329467 , 12.3407049 ,  9.56159685,  7.57591278, 10.10975554,
        7.93827626,  9.13537051,  7.60152974,  9.38565153, 11.81754113,
        9.36398948,  7.20392105, 10.44112808,  6.92047765,  9.23119807,
        7.8427581 ,  9.22659365,  8.1144806 ,  5.74783036,  8.25537613,
        8.20274792,  8.62126246,  7.97708557,  7.35347851, 10.2506039 ,
        9.59100724,  9.36421491,  7.33102668,  9.5573242 , 12.37072232,
        9.54970688, 11.41211392,  7.39054189,  8.03407632, 10.78435189,
        7.43718712,  7.88095529,  6.51764949,  9.02856407, 10.99353164,
       10.54751589,  8.06772683,  9.79379501,  9.90545206, 11.41398531,
        9.07503328, 12.40843255,  7.90827046, 13.53221437, 10.77192659,
        8.49787503,  8.34953755,  9.38006343, 11.25578798,  6.64920457,
        7.25532424,  8.44300818,  7.32817556, 10.21321072, 10.71700613,
        8.28028952, 11.53348204,  8.91579063,  8.89047236, 11.88160754,
       10.57849665,  7.12733534,  8.59249606, 11.85917035,  8.03760057,
        8.33570634,  8.76225167,  9.62215336,  7.73031389,  8.56175289,
        7.95851598,  7.81698831,  8.42213101,  7.12058   , 10.64179869,
       11.3933416 ,  9.28842251, 10.47957494,  8.75599604,  8.35174487,
       10.29309453,  7.82518421, 11.50957697,  7.79752462,  9.82635389,
        9.19270527,  7.49133838,  7.27916312,  7.38027889,  8.1360914 ,
       12.38956639,  9.20465631, 12.61150127,  6.28730561, 13.90257404,
        7.31779157,  9.41366072,  8.78871258,  9.48034117,  8.00478989,
       10.2545427 ,  9.86058708, 10.14543719,  7.20649371,  8.46979322,
       13.01906128, 10.64260369,  7.8376215 ,  8.69202332,  8.5891054 ,
        9.74161906, 11.48050576, 13.99101347,  7.74026238,  8.02296445,
        8.17087577, 10.43804153,  7.6912581 ,  8.99013182, 10.39726289,
        6.48703484,  8.93410365, 12.54368703, 12.49136072, 11.81517005,
        6.23835187,  6.74184563, 13.70920994,  7.70349829,  9.90734141,
        9.30092138, 10.07107089, 10.24998118, 10.01593278,  8.10225227,
       11.70298275, 10.06675627,  9.4263875 , 11.89425655,  7.00659854,
        8.30795811,  3.94693553,  7.3592013 ,  7.81469394,  8.03888716,
        9.9472992 ,  9.78774488, 12.66181769, 12.48388937,  8.78381507,
        8.64794831,  9.26179743,  9.47630416, 10.78006571,  8.29683386,
       11.44060539, 12.26755817,  9.03827709,  6.38405648, 14.01931687]
)


def clean(path, test=False):
    """ Add the path to your train data or your test data in order to apply the transformations to it"""
    #This function takes the string argument for the path of the train.csv input str_path
    
    train = train_clean(path, test)
    store = store_clean()
    
    merged = train.merge(store, on='Store', how='inner')
    
    return merged